{% extends "inner.html" %}
{% load i18n two_factor static common_tags %}

{% block extra_css %}
{% if wizard.steps.current == 'sms' %}
<link rel="stylesheet" href="{% static 'js/libs/intl-tel-input-master/css/intlTelInput.css' %}">
{% endif %}
{% endblock %}

{% block extra_js %}
{% if wizard.steps.current == 'sms' %}
<script src="{% static 'js/libs/intl-tel-input-master/js/intlTelInput.min.js' %}"></script>
<script src="{% static 'js/libs/intl-tel-input-master/js/utils.js' %}"></script>
{% endif %}
{% endblock %}

{% block workspace %}

  <header class="heading">
    <h1>{% block title %}{% trans "Enable Two-Factor Authentication" %}{% endblock %}</h1>
  </header>

  <div class='fields tfa'>

  <form action="" method="post">{% csrf_token %}
      {{ wizard.management_form }}
      {# {{ wizard.form.as_ul }} #}

  {% if wizard.steps.current == 'welcome' %}
    <p>You are about to take your account security to the next level.</p>
    <p>Follow the steps in this wizard to enable two-factor authentication.</p>
  
  {% elif wizard.steps.current == 'method' %}

    <p>Please select which authentication method you would like to use.</p>

        <ul class='tfa-fields-list'>
          <li><label for="id_method-method_0">Method:</label>
            <ul id="id_method-method">
              <li>
                <label for="id_method-method_0"><input type="radio" name="method-method" value="generator" required checked id="id_method-method_0" />
                  Codes generator (e.g Google Authenticator app)</label>
              </li>
              <li>
                <label for="id_method-method_1"><input type="radio" name="method-method" value="sms" required id="id_method-method_1" />
                  Text message (SMS codes)</label>
              </li>
            </ul>
          </li>
        </ul>
  
  {% elif wizard.steps.current == 'generator' %}

    <p>To start using a token generator, please use your smartphone to scan the QR code below. 
      <br/>For example, use <a href="https://support.google.com/accounts/answer/1066447" target='blank'>Google Authenticator</a> app.
    </p>
    <p>Then, enter the code generated by the app.</p>

     <p><img src="{{ QR_URL }}" alt="QR Code" class='qr' /></p>

    <ul class='tfa-fields-list'>
      <li>
          {% if wizard.form.errors.token %}{{ wizard.form.errors.token }}{% endif %}
          <label for="id_generator-token">Code:</label>
          <input type="text" name="generator-token" required id="id_generator-token" pattern="[0-9]{4,6}" />
      </li>
    </ul>
  
  {% elif wizard.steps.current == 'sms' %}

    <p>Please enter the phone number you wish to receive the text messages on.</p>
    <p>This number will be validated in the next step.</p>

    <ul class='tfa-fields-list'>
      <li>
        {% if wizard.form.errors.number %}{{ wizard.form.errors.number }}{% endif %}
        <label for="id_tel-number">Phone Number:</label>
        <input type="tel" name="tel-number" required id="id_tel-number" />
      </li>
    </ul>

  {% elif wizard.steps.current == 'call' %}
  
  <p>Please enter the phone number you wish to be called on.</p>
  <p>This number will be validated in the next step. </p>
  
  {% elif wizard.steps.current == 'validation' %}
    {% if challenge_succeeded %}
      {% if device.method == 'call' %}
        <p>We are calling your phone right now, please enter the
          digits you hear.</p>
      {% elif device.method == 'sms' %}
        <p>We sent you a text message, please enter the code we sent.</p>
      {% endif %}
  
      <ul class='tfa-fields-list'>
          <li>
            {% if wizard.form.errors.token %}{{ wizard.form.errors.token }}{% endif %}
            <label for="id_validation-token">Code:</label>
            <input type="text" name="validation-token" required id="id_validation-token" pattern="[0-9]{4,6}" />
          </li>
      </ul>
    {% else %}
      <p class="error">We've
        encountered an issue with the selected authentication method. Please
        go back and verify that you entered your information correctly, try
        again, or use a different authentication method instead. If the issue
        persists, contact the site administrator.</p>
    {% endif %}
  {% elif wizard.steps.current == 'yubikey' %}
    <p>To identify and verify your YubiKey, please insert a
      token in the field below. Your YubiKey will be linked to your
      account.</p>
  {% endif %}
  
    {# hidden submit button to enable [enter] key #}
    <div style="margin-left: -9999px"><input type="submit" value=""/></div>

    {% if current_membership %}
      <a href="{% url 'profiles:edit' pk=current_membership.pk %}" class="btn btn-gray btn-asize">{% trans "Cancel" %}</a>
    {% endif %}

    <!-- {% if wizard.steps.prev %}
    <button name="wizard_goto_step" type="submit"
            value="{{ wizard.steps.prev }}"
            class="btn btn-gray btn-asize">{% trans "Back" %}</button>
    {% endif %} -->
  
    <button type="submit" class="btn btn-asize btn-primary">{% trans "Next" %}</button>

  </form>
</div>

{% if wizard.steps.current == 'sms' %}
<script>
$("#id_tel-number").intlTelInput({hiddenInput: "sms-number"});
</script>
{% endif %}

{% endblock %}
